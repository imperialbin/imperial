<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/ec3f0c8487.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script>
    let pfpErrorMessage = '<%= JSON.stringify(pfpError) %>'
    if (location.pathname == '/account/changePfp' && pfpErrorMessage == 'false' || location.pathname == '/account/changePfpGravatar' && pfpErrorMessage == 'false' || location.pathname == '/account/createInvite') {
      location.href = '/account';
    }
  </script>
  <link rel="stylesheet" href="/assets/css/reallyGlobal.css?v=3">
  <link rel="stylesheet" href="/assets/css/secondary.css">
  <link rel="stylesheet" href="/assets/css/account.css?v=5">
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6.2.7/animations/shift-away.css" />
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png">
  <meta property="og:image" content="/assets/favicon/favicon-96x96.png">
  <meta name="description" content="View your account here!">
  <title>IMPERIAL | Account</title>
</head>

<body>
  <nav>
    <ul>
      <li>
        <a href="/" class="noOpacity">
          <img src="/assets/img/Logo.png" alt="IMPERIAL's logo" class="logo" draggable="false">
        </a>
      </li>
      <li>
        <a href="#home" class="tooltip" data-tippy-content="General">
          <i class="fas fa-house-user"></i>
        </a>
      </li>
      <li>
        <a href="#documents" class="tooltip" data-tippy-content="Documents">
          <i class="fas fa-file-archive"></i>
        </a>
      </li>
      <li>
        <a href="#codes" class="tooltip" data-tippy-content="Codes">
          <i class="fas fa-qrcode"></i>
        </a>
      </li>
      <li>
        <a href="#api" class="tooltip" data-tippy-content="API">
          <i class="fas fa-code"></i>
        </a>
      </li>
      <div class="logout">
        <a href="/logout" class="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
        </a>
      </div>
    </ul>
  </nav>
  <main>

    <!-- GENERAL SHIT -->
    <h1>Welcome back, <%= user.name %></h1>
    <div class="stat-tiles">
      <div class="stat-tile stat-pfp">
        <img src="<%= user.icon %>" alt="<%= user.name %>'s pfp" draggable="false">
      </div>
      <div class="stat-tile">
        <h6>User ID</h6>
        <span class="stat">#<%= user.userId %></span>
      </div>
      <div class="stat-tile">
        <h6>Documents made</h6>
        <span class="stat"><%= user.documentsMade %></span>
      </div>
    </div>
    <h2 id="home">general</h2>
    <div>
      <label for="email">Email:</label>
      <div class="space"></div>
      <div class="tile"><i class="far fa-envelope"></i></div>
      <input type="text" id="email" name="email" value="<%= user.email %>" readonly>
    </div>
    <div>
      <label for="memberPlus">Account status:</label>
      <div class="space"></div>
      <div class="tile"><i class="fas fa-plus"></i></div>
      <input type="text" id="memberPlus" name="memberPlus" value="<%= user.memberPlus ? "Member+" : "Member" %>"
        readonly disabled>
      <% if (!user.memberPlus) { %>
      <br>
      <a href="/redeem">
        <span>Have a Member+ code?</span>
      </a>
      <br><br>
      <% } %>
    </div>
    <div>
      <label for="inviteCode">Your invite code:</label>
      <div class="space"></div>
      <div class="tile"><i class="fas fa-qrcode"></i></div>
      <input type="text" id="inviteCode" name="inviteCode" value="<%= user.betaCode %>" readonly disabled>
    </div>
    <div>
      <form action="/account/changePfp" id="pfpForm" method="POST">
        <label for="pfp">Profile picture:</label>
        <div class="space"></div>
        <div class="tile"><i class="fas fa-user"></i></div>
        <input type="text" id="pfp" class="withBtn" name="pfp" placeholder="Enter your Github name" required>
        <button type="submit" class="inlineBtn">Change</button>
      </form>
      <span class="clickable" id="platformBtn" onclick="togglePfpType('gravatar')">Or use gravatar</span>
    </div>

    <!-- DOCUMENTS  -->
    <h2 id="documents">Documents</h2>
    <% if (documents[0]) { %>
    <form action="/api/purgeDocuments?_method=DELETE" method="POST">
      <button type="submit" class="tooltip alignedLeftBtn" data-tippy-content="Purge all of your documents">Purge
        Documents</button>
    </form>
    <% documents.forEach(document => { %>
    <div id="<%= document.URL %>">
      <a href="/p/<%= document.URL %>" class="noOpacity">
        <div class="tile"><i class="fas fa-file-alt"></i></div>
        <input type="text" name="documentInfo" class="document" value="<%= document.URL %>" readonly>
      </a>
      <div class="secondaryTiles">
        <% if (!document.instantDelete) { %>
        <div class="secondaryTile infoTip"
          data-tippy-content="Deleting <%= new Date(document.deleteDate).getMonth() + 1 %>/<%= new Date(document.deleteDate).getDate() %>/<%= new Date(document.deleteDate).getFullYear() %>">
          <i class="fas fa-info"></i>
        </div>
        <% } else { %>
        <div class="secondaryTile infoTip" data-tippy-content="Deletes after being viewed"><i class="fas fa-info"></i>
        </div>
        <% } %>
        <div class="secondaryTile infoTip danger deleteDocument" onclick="deleteDocument('<%= document.URL %>')"
          data-tippy-content="Delete document"><i id="<%= document.URL %>-icon" class="fas fa-trash"></i>
        </div>

        <% if (document.encrypted) { %>
        <div class="secondaryTile infoTip key" data-tippy-content="Password protected"><i class="fas fa-key"></i>
        </div>
        <% } %>
      </div>
    </div>
    <% }) %>
    <% } else { %>
    <span>You have not made any recent documents!</span>
    <% } %>

    <!-- INVITE CODES -->
    <h2 id="codes">Your invite codes</h2>
    <form action="/account/createInvite" method="POST">
      <% if (user.codesLeft > 0) { %>
      <button type="submit" class="tooltip alignedLeftBtn"
        data-tippy-content="You have <%= user.codesLeft %> codes left">Create invite</button>
      <% } else { %>
      <div class="cum tooltip" data-tippy-content="You do not have any invite codes!">
        <button type="submit" class=" alignedLeftBtn" disabled>Create invite</button>
      </div>
      <% } %>
    </form>
    <% user.codes.forEach(code => { %>
    <div>
      <div class="tile"><i class="fas fa-qrcode"></i></div>
      <input type="text" name="code" value="<%= code.code %>" readonly>
      <div class="secondaryTiles">
        <div class="secondaryTile codeTile tooltip" data-tippy-content="Copy"
          onclick="copyThisPlease('https://www.imperialb.in/register?inviteCode=<%= code.code %>')">
          <i id="https://www.imperialb.in/register?inviteCode=<%= code.code %>-icon" class="fas fa-copy"></i>
        </div>
      </div>
    </div>
    <% }) %>

    <!-- API STUFF -->
    <h2 id="api">API</h2>
    <div>
      <label for="apiToken">API Token:</label>
      <div class="space"></div>
      <div class="tile"><i class="fas fa-fingerprint"></i></div>
      <input type="text" id="apiToken" class="sensitive token" name="apiToken" value="<%= user.apiToken %>" readonly>
      <div class="secondaryTile codeTile tooltip" data-tippy-content="Copy"
        onclick="copyThisPlease('<%= user.apiToken %>')">
        <i id="<%= user.apiToken %>-icon" class="fas fa-copy"></i>
      </div>
    </div>
    <div>
      <a href="/api/getShareXConfig/<%= user.apiToken %>" class="noOpacity" download>
        <button>Download ShareX Config</button>
      </a>
    </div>

    <!-- RESET PASSWORD STUFF -->
    <h2 id="reset">Reset your password</h2>
    <form action="/account/resetPasswordForm" method="POST">
      <div>
        <div class="tile"><i class="fas fa-unlock"></i></div>
        <input type="password" id="oldPassword" name="oldPassword" placeholder="Old password" autocomplete="off"
          required>
      </div>
      <div>
        <div class="tile"><i class="fas fa-lock"></i></div>
        <input type="password" id="newPassword" name="newPassword" placeholder="New password" autocomplete="off"
          required>
      </div>
      <div>
        <div class="tile"><i class="fas fa-lock"></i></div>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm password"
          autocomplete="off" required>
      </div>
      <button type="submit" class="alignedLeftBtn" id="password">Reset Password</button>
    </form>
    <br><br>
  </main>
  <script src="https://kit.fontawesome.com/ec3f0c8487.js" crossorigin="anonymous"></script>
  <script>
    tippy('.tooltip', {
      arrow: true,
      animation: 'shift-away',
      placement: 'right'
    })
    tippy('.infoTip', {
      animation: 'shift-away',
      placement: 'top'
    })

    function copyThisPlease(thingToCopy) {
      const stupidBox = document.createElement('textarea');
      stupidBox.value = thingToCopy;
      document.body.appendChild(stupidBox)
      stupidBox.select()
      document.execCommand('copy');
      document.body.removeChild(stupidBox)
      document.getElementById(`${thingToCopy}-icon`).classList.replace('fa-copy', 'fa-check')
      setTimeout(() => document.getElementById(`${thingToCopy}-icon`).classList.replace('fa-check', 'fa-copy'), 1000)
    }

    function deleteDocument(documentId) {
      // Set the icon to a minus sign
      document.getElementById(`${documentId}-icon`).classList.replace('fa-trash', 'fa-minus')
      fetch(`/api/document/${documentId}`, {
        method: 'DELETE'
      })
        .then(res => res.json())
        .then(documentRes => {
          console.log(documentRes);
          if (documentRes.success) {
            document.getElementById(`${documentId}-icon`).classList.replace('fa-minus', 'fa-check');
            setTimeout(() => document.getElementById(documentId).remove(), 1500)
          } else {
            document.getElementById(`${documentId}-icon`).classList.replace('fa-minus', 'fa-times');
          }
        })
        .catch(err => {
          console.log(err);
        })
    }

    function togglePfpType(platform) {
      const placeholderElement = document.getElementById('pfp');
      const form = document.getElementById('pfpForm');
      const changePlatformBtn = document.getElementById('platformBtn');
      if(platform === 'gravatar') {
        placeholderElement.placeholder = 'Enter your gravatar email'
        form.action = '/account/changePfpGravatar'
        changePlatformBtn.innerHTML = 'Or use Github'
        changePlatformBtn.setAttribute("onclick", "togglePfpType('github')")
      } else {
        placeholderElement.placeholder = 'Enter your Github name'
        form.action = '/account/changePfp'
        changePlatformBtn.innerHTML = 'Or use Gravatar'
        changePlatformBtn.setAttribute("onclick", "togglePfpType('gravatar')")
      }
    }
  </script>
  <!--
  <i class="error">
    <% if( pfpError ) {%>
    <br><br>
    <%= pfpError %><br>
    <% } %>
  </i>

  <br>
  <i class="error">
    <% if( error ) {%>
    <%= error %>
    <% } %>
    <% if( success ) {%>
    <%= success %>
    <% } %>
  </i>
  <form action="/account/resetPasswordForm" method="POST">
    <h2 id="resetPassword">Reset password</h2>
    <div>
      <input type="password" id="oldPassword" name="oldPassword" placeholder="Old password" autocomplete="off" required>
    </div>
    <div>
      <input type="password" id="newPassword" name="newPassword" placeholder="New password" autocomplete="off" required>
    </div>
    <div>
      <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm password"
        autocomplete="off" required>
    </div>
    <button type="submit" id="password">Reset Password</button>
  </form><br><br><br>

  <script>
    tippy('.tooltip', { arrow: false })
    function togglePfpType(type) {
      const label = document.getElementById('pfpLabel')
      const button = document.querySelector('.dynamicFunction');
      const form = document.getElementById('changePfpForm');
      const dynamicPfpChoice = document.getElementById('dynamicPfpChoice');
      var textBox = document.querySelector("#pfp")
      if (type == 'github') {
        label.innerHTML = 'User icon (via GitHub)';
        textBox.placeholder = 'Enter your GitHub username'
        button.setAttribute('onclick', "togglePfpType('gravatar')")
        form.action = '/account/changePfp'
        dynamicPfpChoice.innerHTML = 'Or use Gravatar'
      } else {
        label.innerHTML = 'User icon (via Gravatar)';
        textBox.placeholder = 'Enter your Gravatar email'
        button.setAttribute('onclick', "togglePfpType('github')")
        form.action = '/account/changePfpGravatar'
        dynamicPfpChoice.innerHTML = 'Or use Github'
      }
    }
    function copyLink(code) {
      const linkBox = document.createElement('textarea');
      linkBox.value = `https://www.imperialb.in/register?inviteCode=${code}`
      document.body.appendChild(linkBox);
      linkBox.select();
      document.execCommand('copy');
      document.body.removeChild(linkBox);
    }
    function copyApi(api) {
      const linkBox = document.createElement('textarea');
      linkBox.value = api
      document.body.appendChild(linkBox);
      linkBox.select();
      document.execCommand('copy');
      document.body.removeChild(linkBox);
    }
  </script> -->
</body>

</html>